#!/usr/bin/env ruby
require 'optparse'

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: cuukie [options]"

  opts.on("--[no-]wait", "Wait for key press at the end") do |wait|
    options[:wait] = wait
  end
end.parse!

at_exit do
  require 'rest-client'
  begin
    RestClient.delete 'http://localhost:4569'
  rescue; end
end

Process.detach(fork do
  exec "ruby #{File.dirname(__FILE__)}/cuukie_server >/dev/null 2>&1"
end)

puts 'View your features at http://localhost:4569'

system "cucumber #{ARGV.join(' ')} --format cuukie"

puts 'All features checked. Press a key to exit.'
gets if options[:wait]
