#!/usr/bin/env ruby
lib = File.dirname(__FILE__) + '/../lib'
$:.unshift lib unless $:.include? lib

require 'cuukie/cli'
include Cuukie::Cli
cuukie_options = []
['--nowait', '--showpage', '--keepserver', '-h', '--help'].each do |arg|
  cuukie_options << ARGV.delete(arg) 
end
if (ARGV.include? '--cuukieport')
  cuukie_options << ARGV.delete('--cuukieport') << ARGV[ARGV.index('--cuukieport')]
end
options = parse_options cuukie_options.compact!
exit if options.empty?

at_exit do
  require 'rest-client'
  begin
    RestClient.delete 'http://localhost:4569' unless options[:keepserver]
  rescue; end
end

# FIXME: use --port
Process.detach(fork do
  system "ruby #{File.dirname(__FILE__)}/cuukie_server >/dev/null 2>&1"
end)

if options[:showpage]
#  require 'launchy'
#  Launchy.open("http://localhost:#{options[:cuukieport]}")
else
  # FIXME: use --port
  puts 'View your features at http://localhost:4569' 
end

# TODO: auto-require formatter (warning: if you tell Cucumber to --require
# something, it will want to --require everything!)
system "cucumber #{ARGV.join(' ')} --format cuukie"

puts 'All features checked'

if options[:wait]
  puts 'Press a key to exit'
  gets
end
